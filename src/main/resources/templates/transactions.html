<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(
        ~{::title},
        ~{::section},
        ~{::styles},
        ~{::scripts}
      )}">
<head>
    <title>Transactions</title>
    <th:block th:fragment="styles">
        <style>
            .transaction-card {
                background: rgba(18, 18, 18, 0.85);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.05);
                border-radius: 1rem;
                margin-bottom: 1rem;
                position: relative;
                z-index: 1;
            }

            /* When dropdown is open, bump that card's z-index above others */
            .transaction-card:has(.dropdown.show) {
                z-index: 1100 !important;
            }
            /* Type card UI for add transaction modal */
            .type-cards { display:flex; gap:0.75rem; }
            .type-card {
                flex:1 1 0;
                cursor:pointer;
                padding:0.75rem 1rem;
                border-radius:0.75rem;
                border:1px solid rgba(255,255,255,0.06);
                display:flex;
                align-items:center;
                justify-content:center;
                gap:0.75rem;
                transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
                user-select:none;
            }
            .type-card .type-label { font-weight:600; color:#fff; }
            .type-card .type-icon { font-size:1.1rem; }
            .type-card.type-income { background: linear-gradient(135deg, rgba(34,197,94,0.12), rgba(34,197,94,0.06)); border-color: rgba(34,197,94,0.25); }
            .type-card.type-expense { background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06)); border-color: rgba(239,68,68,0.25); }
            .type-card.active { box-shadow: 0 8px 20px rgba(0,0,0,0.45); transform: translateY(-3px); border-width:2px; }
            .type-card.type-income.active { border-color: rgba(34,197,94,0.8); }
            .type-card.type-expense.active { border-color: rgba(239,68,68,0.8); }
            .type-card:focus { outline:none; box-shadow: 0 0 0 3px rgba(99,102,241,0.08); }

            .add-transaction-btn {
                background: linear-gradient(135deg, #6366F1 0%, #4338CA 100%);
                border: none;
                transition: opacity 0.2s;
            }
            .add-transaction-btn:hover {
                opacity: 0.9;
            }

            /* Custom Select Box Styling */
            .form-control, .form-select {
                background-color: #000000 !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                color: #ffffff !important;
                border-radius: 0.5rem;
                transition: all 0.3s ease;
            }

            .form-control:focus, .form-select:focus {
                background-color: #000000 !important;
                border-color: #dc3545 !important;
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
                color: #ffffff !important;
            }

            .form-control::placeholder {
                color: rgba(255, 255, 255, 0.6) !important;
            }

            /* Select dropdown styling */
            select.form-control option, select.form-select option {
                background-color: #000000 !important;
                color: #ffffff !important;
                border: none;
                padding: 8px 12px;
            }

            select.form-control option:hover, select.form-select option:hover {
                background-color: #dc3545 !important;
                color: #ffffff !important;
            }

            select.form-control option:checked, select.form-select option:checked {
                background-color: #dc3545 !important;
                color: #ffffff !important;
                font-weight: bold;
            }

            /* Bootstrap dropdown menu styling for transaction actions */
            .dropdown-menu {
                background-color: rgba(25, 25, 25, 0.95) !important;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                border-radius: 0.5rem;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                z-index: 2000 !important;
                margin-top: 5px;
            }

            .dropdown-item {
                color: #ffffff !important;
                transition: all 0.2s ease;
                border-radius: 0.25rem;
                margin: 2px 4px;
            }

            .dropdown-item:hover, .dropdown-item:focus {
                background-color: rgba(99, 102, 241, 0.2) !important;
                color: #ffffff !important;
            }

            .dropdown-item.text-danger:hover {
                background-color: rgba(220, 53, 69, 0.2) !important;
                color: #dc3545 !important;
            }

            /* Modal improvements */
            .modal {
                z-index: 1055 !important;
            }

            .modal-backdrop {
                z-index: 1054 !important;
                background-color: rgba(0, 0, 0, 0.7);
            }

            .modal-content {
                border-radius: 1rem;
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            }

            /* Transaction card dropdown positioning */
            .transaction-card .dropdown-menu {
                position: absolute;
                right: 0;
                left: auto;
                min-width: 150px;
                transform: translateX(0);
            }

            /* Ensure dropdowns don't go behind other elements */
            .transaction-card {
                overflow: visible;
            }

            .transaction-card .dropdown {
                position: relative;
                z-index: 10;
            }

            .transaction-card .dropdown.show .dropdown-menu {
                z-index: 2001 !important;
            }

            /* Custom checkbox styling */
            .transaction-checkbox {
                width: 18px;
                height: 18px;
                background-color: #000000;
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .transaction-checkbox:checked {
                background-color: #dc3545;
                border-color: #dc3545;
            }

            .transaction-checkbox:focus {
                outline: none;
                box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
            }

            /* Alert styling for bulk actions */
            .alert-info {
                background: rgba(99, 102, 241, 0.2) !important;
                border: 1px solid rgba(99, 102, 241, 0.3) !important;
                color: #a5b4fc !important;
                border-radius: 0.5rem;
            }

            /* Input group styling */
            .input-group-text {
                background-color: #000000 !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                color: #ffffff !important;
            }

            /* Dropdown toggle button in transaction cards */
            .transaction-card .btn-outline-secondary {
                background-color: transparent;
                border-color: rgba(255, 255, 255, 0.2);
                color: rgba(255, 255, 255, 0.7);
                padding: 4px 8px;
                font-size: 0.75rem;
            }

            .transaction-card .btn-outline-secondary:hover {
                background-color: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.3);
                color: #ffffff;
            }

            /* Category name styling - visible across all pages */
            .category-name {
                color: #a8b3cf !important;
                font-weight: 500;
                font-size: 0.875rem;
            }

            /* Override text-muted for category names everywhere */
            .text-muted.category-name,
            small.category-name {
                color: #a8b3cf !important;
            }

            /* Brighten transaction list text for readability */
            .transaction-card h6 {
                color: rgba(255, 255, 255, 0.95);
            }
            .transactions-container h5 {
                color: rgba(255, 255, 255, 0.88);
            }
            .transaction-card .text-muted {
                color: rgba(255, 255, 255, 0.7) !important;
            }
        </style>
    </th:block>
</head>
<body>
    <section>
        <div class="container-fluid py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Transactions</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#mpesaUploadModal">
                        <i class="fas fa-file-upload me-2"></i>Upload M-Pesa Statement
                    </button>
                    <button class="btn btn-primary add-transaction-btn" data-bs-toggle="modal" data-bs-target="#addTransactionModal">
                        <i class="fas fa-plus me-2"></i>Add Transaction
                    </button>
                </div>
            </div>
            <div class="transactions-container">
                <!-- Transactions will be loaded here dynamically -->
            </div>
        </div>

        <!-- Add Transaction Modal -->
        <div class="modal fade" id="addTransactionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: white;">
                    <div class="modal-header border-bottom border-secondary">
                        <h5 class="modal-title">Add New Transaction</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addTransactionForm">
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <div class="type-cards" id="transactionTypeCards" role="tablist" aria-label="Transaction Type">
                                    <div class="type-card type-expense active" tabindex="0" data-type="EXPENSE" aria-pressed="true">
                                        <i class="fas fa-arrow-up type-icon text-danger"></i>
                                        <span class="type-label">Expense</span>
                                    </div>
                                    <div class="type-card type-income" tabindex="0" data-type="INCOME" aria-pressed="false">
                                        <i class="fas fa-arrow-down type-icon text-success"></i>
                                        <span class="type-label">Income</span>
                                    </div>
                                </div>
                                <!-- hidden input kept for compatibility with existing JS -->
                                <input type="hidden" id="transactionType" name="type" value="EXPENSE" required>
                            </div>
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-white border-secondary">$</span>
                                    <input type="text"
                                           class="form-control bg-dark text-white"
                                           id="amount"
                                           name="amount"
                                           placeholder="0.00"
                                           style="-moz-appearance: textfield;"
                                           required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="category" class="form-label">Category (Optional)</label>
                                <select class="form-control bg-dark text-white" id="category" name="categoryId">
                                    <option value="">No Category</option>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description</label>
                                <input type="text" class="form-control bg-dark text-white" id="description" name="description" required>
                            </div>
                            <div class="mb-3">
                                <label for="date" class="form-label">Date</label>
                                <input type="date" class="form-control bg-dark text-white" id="date" name="date" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveTransaction">Save Transaction</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Transaction Modal -->
        <div class="modal fade" id="editTransactionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: white;">
                    <div class="modal-header border-bottom border-secondary">
                        <h5 class="modal-title">Edit Transaction</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editTransactionForm">
                            <input type="hidden" id="editTransactionId" name="id">
                            <div class="mb-3">
                                <label for="editTransactionType" class="form-label">Type</label>
                                <select class="form-control bg-dark text-white" id="editTransactionType" name="type" required>
                                    <option value="EXPENSE">Expense</option>
                                    <option value="INCOME">Income</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editAmount" class="form-label">Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark text-white border-secondary">$</span>
                                    <input type="text"
                                           class="form-control bg-dark text-white"
                                           id="editAmount"
                                           name="amount"
                                           placeholder="0.00"
                                           style="-moz-appearance: textfield;"
                                           required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editCategory" class="form-label">Category</label>
                                <select class="form-control bg-dark text-white" id="editCategory" name="categoryId">
                                    <option value="">No Category</option>
                                    <!-- Categories will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDescription" class="form-label">Description</label>
                                <input type="text" class="form-control bg-dark text-white" id="editDescription" name="description" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDate" class="form-label">Date</label>
                                <input type="date" class="form-control bg-dark text-white" id="editDate" name="date" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="updateTransaction">Update Transaction</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Categorize Modal -->
        <div class="modal fade" id="bulkCategorizeModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: white;">
                    <div class="modal-header border-bottom border-secondary">
                        <h5 class="modal-title">Categorize Selected Transactions</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Select a category to assign to <span id="selectedCount">0</span> selected transaction(s):</p>
                        <div class="mb-3">
                            <label for="bulkCategory" class="form-label">Category</label>
                            <select class="form-control bg-dark text-white" id="bulkCategory" name="categoryId">
                                <option value="">No Category</option>
                                <!-- Categories will be loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="bulkCategorizeBtn">Apply Category</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- M-Pesa Statement Upload Modal -->
        <div class="modal fade" id="mpesaUploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content" style="background: rgba(25, 25, 25, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); color: white;">
                    <div class="modal-header border-bottom border-secondary">
                        <h5 class="modal-title">
                            <i class="fas fa-file-upload me-2 text-success"></i>Upload M-Pesa Statement
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Instructions -->
                        <div class="alert alert-info mb-3" style="background: rgba(99, 102, 241, 0.2); border: 1px solid rgba(99, 102, 241, 0.3); color: #a5b4fc;">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>How to upload:</h6>
                            <ol class="mb-0 ps-3" style="font-size: 0.9rem;">
                                <li>Download your M-Pesa statement from the Safaricom app</li>
                                <li>Select the PDF file below</li>
                                <li>We'll automatically extract and categorize your transactions</li>
                                <li>Duplicate transactions will be skipped</li>
                            </ol>
                        </div>

                        <!-- File Upload Form -->
                        <form id="mpesaUploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="mpesaFile" class="form-label">Select M-Pesa Statement (PDF)</label>
                                <div class="input-group">
                                    <input type="file"
                                           class="form-control bg-dark text-white"
                                           id="mpesaFile"
                                           name="file"
                                           accept=".pdf"
                                           required>
                                    <span class="input-group-text bg-dark text-white border-secondary">
                                        <i class="fas fa-file-pdf text-danger"></i>
                                    </span>
                                </div>
                                <small class="text-muted">Maximum file size: 10MB</small>
                            </div>

                            <!-- File info display -->
                            <div id="fileInfo" class="d-none mb-3">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                                <span id="fileName" class="text-white"></span>
                                            </div>
                                            <span id="fileSize" class="badge bg-secondary"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="d-none mb-3">
                                <div class="progress" style="height: 25px; background: rgba(255,255,255,0.1);">
                                    <div id="progressBar"
                                         class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                                         role="progressbar"
                                         style="width: 0%">
                                        <span id="progressText">0%</span>
                                    </div>
                                </div>
                                <small class="text-muted mt-1 d-block">Processing statement...</small>
                            </div>

                            <!-- Upload Result -->
                            <div id="uploadResult" class="d-none">
                                <!-- Success/Error message will be inserted here -->
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-top border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="uploadMpesaBtn">
                            <i class="fas fa-cloud-upload-alt me-2"></i>Upload & Import
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <th:block th:fragment="scripts">
        <script src="/js/transactions.js"></script>
    </th:block>
</body>
</html>